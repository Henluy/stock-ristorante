<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Ristorante</title>
    <meta name="description" content="Gestione stock ristorante con sincronizzazione team">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a6fd8;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-color);
            font-size: 16px;
            line-height: 1.5;
        }

        /* HEADER AMÉLIORÉ */
        .mobile-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-stats {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--dark-color);
        }

        .stat-number {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            min-width: 24px;
            text-align: center;
        }

        /* NAVIGATION CORRIGÉE */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 12px 8px 20px 8px;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.15);
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: #666;
            font-size: 0.75em;
            font-weight: 600;
            min-width: 60px;
        }

        .nav-item.active {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .nav-item:hover {
            background: var(--light-color);
            transform: translateY(-1px);
        }

        .nav-item.active:hover {
            background: var(--primary-dark);
        }

        .nav-icon {
            font-size: 1.4em;
            margin-bottom: 2px;
        }

        /* CONTENU PRINCIPAL */
        .main-content {
            padding: 20px;
            margin-bottom: 100px;
            min-height: calc(100vh - 180px);
        }

        .search-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            font-size: 1em;
            background: white;
            color: var(--dark-color);
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .chip {
            background: white;
            border: 2px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            color: var(--dark-color);
        }

        .chip.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* CARDS PRODOTTI MIGLIORATI */
        .content-cards {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .product-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .product-info h3 {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 5px;
        }

        .product-category {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-align: center;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-low {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-out {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .product-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .stock-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: scale(1.05);
        }

        .btn-secondary:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .stock-display {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--dark-color);
            min-width: 40px;
            text-align: center;
            padding: 8px 12px;
            background: var(--light-color);
            border-radius: 8px;
        }

        .price-display {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--success-color);
        }

        /* FAB AMÉLIORÉ */
        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: var(--transition);
            z-index: 999;
        }

        .fab:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        /* MODALS AMÉLIORÉS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 0;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--light-color);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--dark-color);
            font-size: 1.2em;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        /* FORMS AMÉLIORÉS */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.9em;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: var(--transition);
            background: white;
            color: var(--dark-color);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-full {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 10px;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* SECTION ORDINI */
        .export-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .export-card h3 {
            margin: 0 0 15px 0;
            color: var(--dark-color);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .suppliers-grid {
            margin-bottom: 15px;
        }

        .supplier-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .supplier-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .supplier-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .supplier-header h4 {
            margin: 0;
            font-size: 1em;
            color: var(--dark-color);
            font-weight: 600;
        }

        .supplier-type {
            font-size: 0.75em;
            background: var(--light-color);
            padding: 4px 8px;
            border-radius: 12px;
            color: #666;
            border: 1px solid var(--border-color);
        }

        .supplier-info {
            margin-bottom: 12px;
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
        }

        .supplier-note {
            font-style: italic;
            margin-top: 5px;
            color: #555;
        }

        .supplier-stats {
            font-weight: 600;
            color: var(--primary-color);
        }

        .supplier-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 12px;
            border: none;
            border-radius: 15px;
            font-size: 0.75em;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            flex: 1;
            min-width: 80px;
        }

        .order-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--warning-color);
            transition: var(--transition);
        }

        .order-card.completed {
            border-left-color: var(--success-color);
            opacity: 0.85;
        }

        .order-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .order-info h4 {
            margin: 0 0 5px 0;
            font-size: 1em;
            color: var(--dark-color);
            font-weight: 600;
        }

        .order-supplier, .order-date {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 3px;
        }

        .order-status {
            text-align: right;
        }

        .order-total {
            font-weight: bold;
            color: var(--success-color);
            margin-top: 5px;
            font-size: 0.9em;
        }

        .order-items {
            background: var(--light-color);
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            font-size: 0.85em;
            border: 1px solid var(--border-color);
        }

        .order-item {
            margin: 3px 0;
            color: var(--dark-color);
        }

        .order-note {
            font-style: italic;
            color: #666;
            font-size: 0.8em;
            margin: 10px 0;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        /* SECTION CHAT */
        .chat-container {
            background: white;
            border-radius: var(--border-radius);
            height: 500px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .chat-header {
            background: var(--primary-color);
            color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .online-users {
            font-size: 0.8em;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.own {
            align-items: flex-end;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .message.own .message-bubble {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message:not(.own) .message-bubble {
            background: white;
            color: var(--dark-color);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .message-info {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 5px;
            padding: 0 5px;
        }

        .message.own .message-info {
            text-align: right;
        }

        .message-time {
            font-size: 0.65em;
            opacity: 0.7;
            margin-top: 5px;
            padding: 0 5px;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background: white;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            resize: none;
            max-height: 100px;
            font-family: inherit;
            font-size: 0.9em;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: var(--transition);
        }

        .chat-send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* TOAST AMÉLIORÉ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
            box-shadow: var(--shadow);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        .toast.warning {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* RESPONSIVE AMÉLIORÉ */
        @media (max-width: 480px) {
            .main-content {
                padding: 15px;
            }

            .search-card {
                padding: 15px;
            }

            .product-card {
                padding: 15px;
            }

            .header-stats {
                gap: 10px;
                font-size: 0.8em;
            }

            .supplier-actions, .order-actions {
                flex-direction: column;
            }

            .btn-small {
                text-align: center;
                min-width: auto;
            }

            .order-header {
                flex-direction: column;
                gap: 8px;
            }

            .order-status {
                text-align: left;
            }

            .chat-container {
                height: 400px;
            }

            .message-bubble {
                max-width: 90%;
            }
        }

        /* DARK MODE SUPPORT */
        @media (prefers-color-scheme: dark) {
            :root {
                --dark-color: #f8f9fa;
                --light-color: #343a40;
                --border-color: #495057;
            }
        }

        /* ANIMATIONS */
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .content-cards > * {
            animation: slideUp 0.3s ease forwards;
        }

        /* OFFLINE INDICATOR */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--danger-color);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.9em;
            z-index: 10000;
            font-weight: 600;
        }

        /* USER SETUP */
        .user-setup-modal {
            background: rgba(0,0,0,0.8);
        }

        .user-setup-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .user-setup-content h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin: 0 auto 20px;
        }

        /* SYNC STATUS */
        .sync-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sync-status.show {
            opacity: 1;
        }

        .sync-status.syncing {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .sync-status.error {
            background: var(--danger-color);
        }
    </style>
</head>

<body>
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- SYNC STATUS -->
    <div id="syncStatus" class="sync-status">
        <span id="syncStatusText">🔄 Sincronizzazione...</span>
    </div>

    <!-- USER SETUP MODAL -->
    <div id="userSetupModal" class="modal user-setup-modal">
        <div class="user-setup-content">
            <div class="user-avatar">👤</div>
            <h2>Benvenuto!</h2>
            <p>Inserisci il tuo nome per iniziare</p>
            <form id="userSetupForm">
                <div class="form-group">
                    <input type="text" id="userName" class="form-input" placeholder="Il tuo nome" required maxlength="20">
                </div>
                <button type="submit" class="btn-full btn-success">🚀 Inizia</button>
            </form>
        </div>
    </div>

    <!-- HEADER -->
    <div class="mobile-header">
        <div class="header-content">
            <div class="app-title">
                📦 Stock Ristorante
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span>Totali:</span>
                    <span class="stat-number" id="headerTotal">0</span>
                </div>
                <div class="stat-item">
                    <span>Avvisi:</span>
                    <span class="stat-number" id="headerAlerts">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- SEARCH CARD -->
        <div class="search-card">
            <input type="text" id="searchInput" class="search-input" placeholder="🔍 Cerca prodotti...">
            <div class="filter-chips" id="filterChips">
                <div class="chip active" data-filter="">Tutti</div>
                <div class="chip" data-filter="out">Esauriti</div>
                <div class="chip" data-filter="low">Stock Bassi</div>
            </div>
        </div>

        <!-- CONTENT CARDS -->
        <div class="content-cards" id="productList">
            <!-- Content will be dynamically generated -->
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-view="list">
            <div class="nav-icon">📋</div>
            <span>Lista</span>
        </div>
        <div class="nav-item" data-view="categories">
            <div class="nav-icon">📂</div>
            <span>Categorie</span>
        </div>
        <div class="nav-item" data-view="alerts">
            <div class="nav-icon">⚠️</div>
            <span>Avvisi</span>
        </div>
        <div class="nav-item" data-view="orders">
            <div class="nav-icon">🛒</div>
            <span>Ordini</span>
        </div>
        <div class="nav-item" data-view="chat">
            <div class="nav-icon">💬</div>
            <span>Chat</span>
        </div>
        <div class="nav-item" data-view="export">
            <div class="nav-icon">📊</div>
            <span>Export</span>
        </div>
    </nav>

    <!-- FAB -->
    <button class="fab" id="addProductFAB" title="Aggiungi nuovo prodotto">+</button>

    <!-- ADD PRODUCT MODAL -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>➕ Nuovo Prodotto</h3>
                <button class="close-btn" type="button">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="form-group">
                        <label class="form-label">Categoria *</label>
                        <select id="newCategory" class="form-input" required>
                            <option value="">Seleziona categoria</option>
                            <option value="Formaggi">🧀 Formaggi</option>
                            <option value="Verdure">🥬 Verdure</option>
                            <option value="Carne">🥩 Carne</option>
                            <option value="Frutta">🍎 Frutta</option>
                            <option value="Pasta">🍝 Pasta</option>
                            <option value="Salumi">🥓 Salumi</option>
                            <option value="Dolci">🍰 Dolci</option>
                            <option value="Condimenti">🧂 Condimenti</option>
                            <option value="Latticini">🥛 Latticini</option>
                            <option value="Erbe">🌿 Erbe</option>
                            <option value="Pesce">🐟 Pesce</option>
                            <option value="Bevande">🥤 Bevande</option>
                            <option value="Altro">📦 Altro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nome Prodotto *</label>
                        <input type="text" id="newProduct" class="form-input" required placeholder="Es. Mozzarella di Bufala">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Attuale</label>
                        <input type="number" id="newStock" class="form-input" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Minimo</label>
                        <input type="number" id="newMinStock" class="form-input" min="1" value="5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prezzo (€)</label>
                        <input type="number" id="newPrice" class="form-input" min="0" step="0.01" value="0">
                    </div>
                    <button type="submit" class="btn-full btn-success">💾 Salva Prodotto</button>
                    <button type="button" class="btn-full btn-cancel modal-close">❌ Annulla</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBvOkBwN6Ce6FUYd4OOSMgJwVlOPiS41A0",
            authDomain: "stock-ristorante-demo.firebaseapp.com",
            projectId: "stock-ristorante-demo",
            storageBucket: "stock-ristorante-demo.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:0123456789abcdef"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        class StockRistoranteApp {
            constructor() {
                this.currentView = 'list';
                this.currentFilter = '';
                this.searchTerm = '';
                this.currentUser = null;
                this.isOnline = navigator.onLine;
                this.syncStatus = 'offline';
                
                // Data arrays
                this.stockData = [];
                this.ordersData = [];
                this.suppliersData = [];
                this.chatMessages = [];
                
                // ID counters
                this.nextId = 1;
                this.nextOrderId = 1;
                this.nextSupplierId = 1;
                
                this.init();
            }

            async init() {
                this.showLoading();
                
                // Setup user
                await this.setupUser();
                
                // Setup Firebase listeners
                this.setupFirebaseListeners();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Load data
                await this.loadData();
                
                // Setup offline support
                this.setupOfflineSupport();
                
                // Initial render
                this.render();
                
                this.hideLoading();
                
                console.log('📦 Stock Ristorante App inizializzata!');
            }

            // ==================== USER MANAGEMENT ====================
            async setupUser() {
                const savedUser = localStorage.getItem('stockUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                } else {
                    await this.showUserSetup();
                }
            }

            showUserSetup() {
                return new Promise((resolve) => {
                    const modal = document.getElementById('userSetupModal');
                    modal.style.display = 'flex';
                    
                    document.getElementById('userSetupForm').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const userName = document.getElementById('userName').value.trim();
                        
                        if (userName) {
                            this.currentUser = {
                                name: userName,
                                id: Date.now().toString(),
                                avatar: userName.charAt(0).toUpperCase(),
                                joinedAt: new Date().toISOString()
                            };
                            
                            localStorage.setItem('stockUser', JSON.stringify(this.currentUser));
                            modal.style.display = 'none';
                            resolve();
                        }
                    });
                });
            }

            // ==================== FIREBASE SETUP ====================
            setupFirebaseListeners() {
                // Stock data listener
                db.collection('stock').onSnapshot((snapshot) => {
                    if (!snapshot.metadata.fromCache) {
                        this.stockData = [];
                        snapshot.forEach((doc) => {
                            this.stockData.push({ id: doc.id, ...doc.data() });
                        });
                        this.updateNextId();
                        this.render();
                        this.updateSyncStatus('synced');
                    }
                }, (error) => {
                    console.error('Error listening to stock:', error);
                    this.updateSyncStatus('error');
                });

                // Orders listener
                db.collection('orders').onSnapshot((snapshot) => {
                    if (!snapshot.metadata.fromCache) {
                        this.ordersData = [];
                        snapshot.forEach((doc) => {
                            this.ordersData.push({ id: doc.id, ...doc.data() });
                        });
                        this.updateNextOrderId();
                        if (this.currentView === 'orders') this.render();
                    }
                });

                // Suppliers listener
                db.collection('suppliers').onSnapshot((snapshot) => {
                    if (!snapshot.metadata.fromCache) {
                        this.suppliersData = [];
                        snapshot.forEach((doc) => {
                            this.suppliersData.push({ id: doc.id, ...doc.data() });
                        });
                        this.updateNextSupplierId();
                        if (this.currentView === 'orders') this.render();
                    }
                });

                // Chat listener
                db.collection('chat')
                    .orderBy('timestamp', 'asc')
                    .limitToLast(50)
                    .onSnapshot((snapshot) => {
                        if (!snapshot.metadata.fromCache) {
                            this.chatMessages = [];
                            snapshot.forEach((doc) => {
                                this.chatMessages.push({ id: doc.id, ...doc.data() });
                            });
                            if (this.currentView === 'chat') this.renderChatMessages();
                        }
                    });
            }

            updateNextId() {
                this.nextId = Math.max(...this.stockData.map(p => parseInt(p.id) || 0), 0) + 1;
            }

            updateNextOrderId() {
                this.nextOrderId = Math.max(...this.ordersData.map(o => parseInt(o.id) || 0), 0) + 1;
            }

            updateNextSupplierId() {
                this.nextSupplierId = Math.max(...this.suppliersData.map(s => parseInt(s.id) || 0), 0) + 1;
            }

            // ==================== SYNC MANAGEMENT ====================
            updateSyncStatus(status) {
                this.syncStatus = status;
                const statusEl = document.getElementById('syncStatus');
                const textEl = document.getElementById('syncStatusText');
                
                statusEl.className = `sync-status ${status}`;
                
                switch (status) {
                    case 'syncing':
                        textEl.textContent = '🔄 Sincronizzazione...';
                        statusEl.classList.add('show');
                        break;
                    case 'synced':
                        textEl.textContent = '✅ Sincronizzato';
                        statusEl.classList.add('show');
                        setTimeout(() => statusEl.classList.remove('show'), 2000);
                        break;
                    case 'error':
                        textEl.textContent = '❌ Errore sync';
                        statusEl.classList.add('show');
                        setTimeout(() => statusEl.classList.remove('show'), 3000);
                        break;
                    case 'offline':
                        textEl.textContent = '📡 Offline';
                        statusEl.classList.add('show');
                        break;
                }
            }

            async syncToFirebase(collection, data, id = null) {
                if (!this.isOnline) {
                    // Save to local storage for later sync
                    this.saveToLocalStorage();
                    return;
                }

                try {
                    this.updateSyncStatus('syncing');
                    
                    if (id) {
                        await db.collection(collection).doc(id.toString()).set(data);
                    } else {
                        await db.collection(collection).add(data);
                    }
                    
                    this.updateSyncStatus('synced');
                } catch (error) {
                    console.error(`Error syncing to ${collection}:`, error);
                    this.updateSyncStatus('error');
                    this.saveToLocalStorage();
                }
            }

            async deleteFromFirebase(collection, id) {
                if (!this.isOnline) return;

                try {
                    await db.collection(collection).doc(id.toString()).delete();
                } catch (error) {
                    console.error(`Error deleting from ${collection}:`, error);
                }
            }

            // ==================== LOCAL STORAGE ====================
            saveToLocalStorage() {
                localStorage.setItem('stockData', JSON.stringify(this.stockData));
                localStorage.setItem('ordersData', JSON.stringify(this.ordersData));
                localStorage.setItem('suppliersData', JSON.stringify(this.suppliersData));
            }

            loadFromLocalStorage() {
                const stockData = localStorage.getItem('stockData');
                const ordersData = localStorage.getItem('ordersData');
                const suppliersData = localStorage.getItem('suppliersData');

                if (stockData) this.stockData = JSON.parse(stockData);
                if (ordersData) this.ordersData = JSON.parse(ordersData);
                if (suppliersData) this.suppliersData = JSON.parse(suppliersData);

                this.updateNextId();
                this.updateNextOrderId();
                this.updateNextSupplierId();
            }

            // ==================== DATA LOADING ====================
            async loadData() {
                if (this.isOnline) {
                    // Data will be loaded via Firebase listeners
                    this.updateSyncStatus('syncing');
                } else {
                    // Load from local storage
                    this.loadFromLocalStorage();
                    this.updateSyncStatus('offline');
                }

                // Load default data if empty
                if (this.stockData.length === 0) {
                    this.loadDefaultData();
                }
            }

            loadDefaultData() {
                this.stockData = [
                    { id: 1, categoria: 'Formaggi', prodotto: 'Mozzarella di Bufala', stockAttuale: 12, stockMinimo: 5, prezzo: 8.50 },
                    { id: 2, categoria: 'Verdure', prodotto: 'Lattuga Romana', stockAttuale: 0, stockMinimo: 10, prezzo: 2.30 },
                    { id: 3, categoria: 'Carne', prodotto: 'Bistecca di Manzo', stockAttuale: 3, stockMinimo: 8, prezzo: 22.00 },
                    { id: 4, categoria: 'Pasta', prodotto: 'Spaghetti', stockAttuale: 25, stockMinimo: 15, prezzo: 1.50 },
                    { id: 5, categoria: 'Pesce', prodotto: 'Salmone Fresco', stockAttuale: 2, stockMinimo: 5, prezzo: 18.00 },
                    { id: 6, categoria: 'Condimenti', prodotto: 'Olio EVO', stockAttuale: 8, stockMinimo: 3, prezzo: 12.00 },
                    { id: 7, categoria: 'Dolci', prodotto: 'Tiramisù', stockAttuale: 0, stockMinimo: 6, prezzo: 5.50 },
                    { id: 8, categoria: 'Bevande', prodotto: 'Vino Chianti', stockAttuale: 15, stockMinimo: 10, prezzo: 15.00 }
                ];

                this.suppliersData = [
                    { id: 1, nome: 'Metro Cash & Carry', tipo: 'Cash & Carry', telefono: '06-12345678', note: 'Aperto 6-22, carta business necessaria' },
                    { id: 2, nome: 'Conad Superstore', tipo: 'Supermercato', telefono: '06-87654321', note: 'Sconti per ristoratori il martedì' },
                    { id: 3, nome: 'Fornitore Carni Rossi', tipo: 'Fornitore', telefono: '339-1234567', note: 'Consegna gratuita sopra €100' }
                ];

                this.nextId = 9;
                this.nextSupplierId = 4;
                this.nextOrderId = 1;

                this.saveToLocalStorage();
            }

            // ==================== EVENT LISTENERS ====================
            setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        this.switchView(view);
                    });
                });

                // Search
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.searchTerm = e.target.value.toLowerCase();
                    this.render();
                });

                // Filter chips
                document.getElementById('filterChips').addEventListener('click', (e) => {
                    if (e.target.classList.contains('chip')) {
                        document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentFilter = e.target.dataset.filter;
                        this.render();
                    }
                });

                // FAB
                document.getElementById('addProductFAB').addEventListener('click', () => {
                    if (this.currentView === 'orders') {
                        this.openNewOrderModal();
                    } else if (this.currentView === 'chat') {
                        // Focus chat input
                        document.getElementById('chatInput')?.focus();
                    } else {
                        this.openAddProductModal();
                    }
                });

                // Product controls
                document.getElementById('productList').addEventListener('click', (e) => {
                    this.handleProductClick(e);
                });

                // Add product form
                document.getElementById('addProductForm').addEventListener('submit', (e) => {
                    this.handleAddProduct(e);
                });

                // Modal close
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('close-btn') || e.target.classList.contains('modal-close')) {
                        this.closeAllModals();
                    }
                });

                // Online/offline events
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.syncOfflineChanges();
                    this.removeOfflineIndicator();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateSyncStatus('offline');
                    this.showOfflineIndicator();
                });

                // Auto-save
                this.startAutoSave();
            }

            // ==================== OFFLINE SUPPORT ====================
            setupOfflineSupport() {
                if (!this.isOnline) {
                    this.showOfflineIndicator();
                }
            }

            showOfflineIndicator() {
                if (!document.getElementById('offlineIndicator')) {
                    const indicator = document.createElement('div');
                    indicator.id = 'offlineIndicator';
                    indicator.className = 'offline-indicator';
                    indicator.textContent = '📡 Modalità offline - I dati vengono salvati localmente';
                    document.body.appendChild(indicator);
                }
            }

            removeOfflineIndicator() {
                const indicator = document.getElementById('offlineIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            async syncOfflineChanges() {
                if (!this.isOnline) return;

                try {
                    // Sync stock data
                    for (const item of this.stockData) {
                        await this.syncToFirebase('stock', item, item.id);
                    }

                    // Sync orders
                    for (const order of this.ordersData) {
                        await this.syncToFirebase('orders', order, order.id);
                    }

                    // Sync suppliers
                    for (const supplier of this.suppliersData) {
                        await this.syncToFirebase('suppliers', supplier, supplier.id);
                    }

                    this.showToast('Dati sincronizzati!', 'success');
                } catch (error) {
                    console.error('Error syncing offline changes:', error);
                    this.showToast('Errore nella sincronizzazione', 'error');
                }
            }

            // ==================== RENDERING ====================
            render() {
                this.updateStats();
                this.updateFilterChips();

                switch (this.currentView) {
                    case 'list':
                        this.renderProductList();
                        break;
                    case 'categories':
                        this.renderCategoriesView();
                        break;
                    case 'alerts':
                        this.renderAlertsView();
                        break;
                    case 'orders':
                        this.renderOrdersView();
                        break;
                    case 'chat':
                        this.renderChatView();
                        break;
                    case 'export':
                        this.renderExportView();
                        break;
                }
            }

            renderProductList() {
                const filteredData = this.getFilteredData();
                const productList = document.getElementById('productList');

                if (filteredData.length === 0) {
                    productList.innerHTML = `
                        <div class="export-card" style="text-align: center; padding: 40px;">
                            <h3>📦 Nessun prodotto trovato</h3>
                            <p style="color: #666; margin: 10px 0;">Prova a modificare i filtri di ricerca</p>
                            <button class="btn-full btn-success" onclick="stockApp.openAddProductModal()">
                                ➕ Aggiungi il primo prodotto
                            </button>
                        </div>
                    `;
                    return;
                }

                productList.innerHTML = filteredData.map(product => this.createProductCard(product)).join('');
            }

            createProductCard(product) {
                const status = this.getProductStatus(product);
                const statusText = this.getStatusText(status);
                const totalValue = product.stockAttuale * product.prezzo;

                return `
                    <div class="product-card">
                        <div class="product-header">
                            <div class="product-info">
                                <h3>${this.escapeHtml(product.prodotto)}</h3>
                                <div class="product-category">${product.categoria}</div>
                            </div>
                            <div class="status-badge status-${status}">${statusText}</div>
                        </div>
                        
                        <div class="product-controls">
                            <div class="stock-controls">
                                <button class="btn-circle btn-secondary decrease-btn" 
                                        data-product-id="${product.id}"
                                        ${product.stockAttuale <= 0 ? 'disabled' : ''}>−</button>
                                <div class="stock-display">${product.stockAttuale}</div>
                                <button class="btn-circle btn-primary increase-btn" 
                                        data-product-id="${product.id}">+</button>
                            </div>
                            <div class="price-display">€${totalValue.toFixed(2)}</div>
                        </div>
                        
                        ${product.stockAttuale <= product.stockMinimo ? `
                            <div class="order-note">
                                💡 ${this.getAlertSuggestion(product, status)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // ==================== CHAT FUNCTIONALITY ====================
            renderChatView() {
                const productList = document.getElementById('productList');
                
                productList.innerHTML = `
                    <div class="chat-container">
                        <div class="chat-header">
                            <h3>💬 Chat Team</h3>
                            <div class="online-users">👥 Team online</div>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <!-- Messages will be rendered here -->
                        </div>
                        <div class="chat-input-container">
                            <form class="chat-input-form" id="chatForm">
                                <textarea id="chatInput" class="chat-input" 
                                         placeholder="Scrivi un messaggio..." 
                                         rows="1" maxlength="500"></textarea>
                                <button type="submit" class="chat-send-btn" id="chatSendBtn">📤</button>
                            </form>
                        </div>
                    </div>
                `;

                this.setupChatEventListeners();
                this.renderChatMessages();
            }

            setupChatEventListeners() {
                const chatForm = document.getElementById('chatForm');
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('chatSendBtn');

                // Auto-resize textarea
                chatInput.addEventListener('input', () => {
                    chatInput.style.height = 'auto';
                    chatInput.style.height = Math.min(chatInput.scrollHeight, 100) + 'px';
                    
                    // Enable/disable send button
                    const hasText = chatInput.value.trim().length > 0;
                    sendBtn.disabled = !hasText;
                });

                // Send message
                chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendChatMessage();
                });

                // Send on Enter (but not Shift+Enter)
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendChatMessage();
                    }
                });
            }

            async sendChatMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (!message || !this.currentUser) return;

                const messageData = {
                    text: message,
                    userId: this.currentUser.id,
                    userName: this.currentUser.name,
                    userAvatar: this.currentUser.avatar,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    localTimestamp: new Date().toISOString()
                };

                try {
                    if (this.isOnline) {
                        await db.collection('chat').add(messageData);
                    } else {
                        // Add to local messages for offline
                        messageData.id = Date.now().toString();
                        messageData.timestamp = new Date();
                        this.chatMessages.push(messageData);
                        this.renderChatMessages();
                    }
                    
                    chatInput.value = '';
                    chatInput.style.height = 'auto';
                    document.getElementById('chatSendBtn').disabled = true;
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showToast('Errore invio messaggio', 'error');
                }
            }

            renderChatMessages() {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) return;

                if (this.chatMessages.length === 0) {
                    chatMessages.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 2em; margin-bottom: 10px;">💬</div>
                            <p>Nessun messaggio ancora</p>
                            <p style="font-size: 0.9em;">Inizia la conversazione con il team!</p>
                        </div>
                    `;
                    return;
                }

                chatMessages.innerHTML = this.chatMessages.map(message => {
                    const isOwn = message.userId === this.currentUser?.id;
                    const timestamp = message.timestamp?.toDate?.() || new Date(message.localTimestamp);
                    const timeString = timestamp.toLocaleTimeString('it-IT', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });

                    return `
                        <div class="message ${isOwn ? 'own' : ''}">
                            ${!isOwn ? `
                                <div class="message-info">
                                    ${message.userAvatar} ${message.userName}
                                </div>
                            ` : ''}
                            <div class="message-bubble">
                                ${this.escapeHtml(message.text)}
                            </div>
                            <div class="message-time">${timeString}</div>
                        </div>
                    `;
                }).join('');

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // ==================== ORDERS FUNCTIONALITY ====================
            renderOrdersView() {
                const productList = document.getElementById('productList');
                
                productList.innerHTML = `
                    <!-- SUPPLIERS SECTION -->
                    <div class="export-card">
                        <h3>🏪 Fornitori</h3>
                        <div class="suppliers-grid" id="suppliersGrid">
                            ${this.renderSuppliers()}
                        </div>
                        <button class="btn-full btn-success" onclick="stockApp.openAddSupplierModal()">
                            ➕ Aggiungi Fornitore
                        </button>
                    </div>

                    <!-- ORDERS SECTION -->
                    <div class="export-card">
                        <h3>📋 Ordini</h3>
                        <div class="order-actions" style="margin-bottom: 15px;">
                            <button class="btn-small btn-success" onclick="stockApp.openNewOrderModal()">
                                ➕ Nuovo Ordine
                            </button>
                            <button class="btn-small btn-primary" onclick="stockApp.createQuickOrder()">
                                🚀 Ordine Rapido
                            </button>
                        </div>
                        <div id="ordersGrid">
                            ${this.renderOrders()}
                        </div>
                    </div>
                `;
            }

            renderSuppliers() {
                if (this.suppliersData.length === 0) {
                    return `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <p>Nessun fornitore aggiunto</p>
                        </div>
                    `;
                }

                return this.suppliersData.map(supplier => {
                    const orderCount = this.ordersData.filter(o => o.fornitoreId === supplier.id).length;
                    
                    return `
                        <div class="supplier-card">
                            <div class="supplier-header">
                                <h4>${this.escapeHtml(supplier.nome)}</h4>
                                <span class="supplier-type">${supplier.tipo}</span>
                            </div>
                            <div class="supplier-info">
                                ${supplier.telefono ? `📞 ${supplier.telefono}<br>` : ''}
                                <div class="supplier-stats">${orderCount} ordini</div>
                                ${supplier.note ? `<div class="supplier-note">${this.escapeHtml(supplier.note)}</div>` : ''}
                            </div>
                            <div class="supplier-actions">
                                <button class="btn-small btn-primary" onclick="stockApp.createOrderForSupplier(${supplier.id})">
                                    🛒 Ordina
                                </button>
                                <button class="btn-small btn-secondary" onclick="stockApp.editSupplier(${supplier.id})">
                                    ✏️ Modifica
                                </button>
                                <button class="btn-small btn-danger" onclick="stockApp.deleteSupplier(${supplier.id})">
                                    🗑️ Elimina
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderOrders() {
                if (this.ordersData.length === 0) {
                    return `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <p>Nessun ordine creato</p>
                        </div>
                    `;
                }

                return this.ordersData
                    .sort((a, b) => new Date(b.dataCreazione) - new Date(a.dataCreazione))
                    .map(order => {
                        const supplier = this.suppliersData.find(s => s.id === order.fornitoreId);
                        const supplierName = supplier ? supplier.nome : 'Fornitore sconosciuto';
                        const totalValue = order.items ? order.items.reduce((sum, item) => 
                            sum + (item.quantita * item.prezzo), 0) : 0;
                        
                        return `
                            <div class="order-card ${order.stato}">
                                <div class="order-header">
                                    <div class="order-info">
                                        <h4>Ordine #${order.id}</h4>
                                        <div class="order-supplier">🏪 ${this.escapeHtml(supplierName)}</div>
                                        <div class="order-date">📅 ${new Date(order.dataCreazione).toLocaleDateString('it-IT')}</div>
                                    </div>
                                    <div class="order-status">
                                        <div class="status-badge status-${order.stato === 'pending' ? 'low' : 'ok'}">
                                            ${order.stato === 'pending' ? '⏳ In Attesa' : '✅ Completato'}
                                        </div>
                                        <div class="order-total">€${totalValue.toFixed(2)}</div>
                                    </div>
                                </div>
                                
                                ${order.items && order.items.length > 0 ? `
                                    <div class="order-items">
                                        <strong>Prodotti:</strong><br>
                                        ${order.items.slice(0, 3).map(item => 
                                            `• ${item.prodotto} (${item.quantita} ${item.unita || 'pz'})`
                                        ).join('<br>')}
                                        ${order.items.length > 3 ? `<br>... e altri ${order.items.length - 3} prodotti` : ''}
                                    </div>
                                ` : ''}
                                
                                ${order.note ? `
                                    <div class="order-note">
                                        📝 ${this.escapeHtml(order.note)}
                                    </div>
                                ` : ''}
                                
                                <div class="order-actions">
                                    <button class="btn-small btn-primary" onclick="stockApp.viewOrderDetails(${order.id})">
                                        👁️ Dettagli
                                    </button>
                                    ${order.stato === 'pending' ? `
                                        <button class="btn-small btn-success" onclick="stockApp.completeOrder(${order.id})">
                                            ✅ Completato
                                        </button>
                                        <button class="btn-small btn-secondary" onclick="stockApp.editOrder(${order.id})">
                                            ✏️ Modifica
                                        </button>
                                    ` : ''}
                                    <button class="btn-small btn-danger" onclick="stockApp.deleteOrder(${order.id})">
                                        🗑️ Elimina
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
            }

            // ==================== CATEGORIES VIEW ====================
            renderCategoriesView() {
                const categoriesData = this.groupByCategory();
                const productList = document.getElementById('productList');

                productList.innerHTML = Object.entries(categoriesData).map(([category, products]) => {
                    const totalValue = products.reduce((sum, p) => sum + (p.stockAttuale * p.prezzo), 0);
                    const lowStockCount = products.filter(p => this.getProductStatus(p) !== 'ok').length;
                    
                    return `
                        <div class="export-card">
                            <h3>${this.getCategoryIcon(category)} ${category}</h3>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.9em;">
                                <span>${products.length} prodotti</span>
                                <span>€${totalValue.toFixed(2)}</span>
                                ${lowStockCount > 0 ? `<span style="color: var(--danger-color);">${lowStockCount} avvisi</span>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${products.map(product => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; 
                                                padding: 8px; background: var(--light-color); border-radius: 6px;">
                                        <div>
                                            <strong>${this.escapeHtml(product.prodotto)}</strong>
                                            <div style="font-size: 0.8em; color: #666;">Stock: ${product.stockAttuale}</div>
                                        </div>
                                        <div class="status-badge status-${this.getProductStatus(product)}">
                                            ${this.getStatusText(this.getProductStatus(product))}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // ==================== ALERTS VIEW ====================
            renderAlertsView() {
                const alertProducts = this.stockData.filter(p => this.getProductStatus(p) !== 'ok');
                const productList = document.getElementById('productList');

                if (alertProducts.length === 0) {
                    productList.innerHTML = `
                        <div class="export-card" style="text-align: center; padding: 40px;">
                            <h3>✅ Tutto OK!</h3>
                            <p style="color: #666; margin: 10px 0;">Nessun avviso di stock</p>
                        </div>
                    `;
                    return;
                }

                // Group by urgency
                const urgent = alertProducts.filter(p => this.getProductStatus(p) === 'out');
                const warning = alertProducts.filter(p => this.getProductStatus(p) === 'low');

                productList.innerHTML = `
                    ${urgent.length > 0 ? `
                        <div class="export-card" style="border-left: 4px solid var(--danger-color);">
                            <h3>🚨 URGENTI (${urgent.length})</h3>
                            <p style="color: var(--danger-color); margin-bottom: 15px;">Prodotti esauriti</p>
                            ${urgent.map(product => this.createAlertCard(product)).join('')}
                        </div>
                    ` : ''}
                    
                    ${warning.length > 0 ? `
                        <div class="export-card" style="border-left: 4px solid var(--warning-color);">
                            <h3>⚠️ ATTENZIONE (${warning.length})</h3>
                            <p style="color: #856404; margin-bottom: 15px;">Stock bassi</p>
                            ${warning.map(product => this.createAlertCard(product)).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="export-card">
                        <button class="btn-full btn-success" onclick="stockApp.createQuickOrder()">
                            🚀 Crea Ordine Rapido per Prodotti in Esaurimento
                        </button>
                    </div>
                `;
            }

            createAlertCard(product) {
                const status = this.getProductStatus(product);
                const suggestion = this.getAlertSuggestion(product, status);
                
                return `
                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; 
                                border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <strong>${this.escapeHtml(product.prodotto)}</strong>
                                <div style="font-size: 0.8em; color: #666;">${product.categoria}</div>
                            </div>
                            <div class="status-badge status-${status}">
                                ${this.getStatusText(status)}
                            </div>
                        </div>
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                            Stock: ${product.stockAttuale}/${product.stockMinimo} • €${product.prezzo}
                        </div>
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 8px; border-radius: 4px; 
                                    font-size: 0.8em; color: var(--primary-color); font-weight: 500;">
                            💡 ${suggestion}
                        </div>
                    </div>
                `;
            }

            // ==================== EXPORT VIEW ====================
            renderExportView() {
                const stats = this.getInventoryStats();
                const productList = document.getElementById('productList');

                productList.innerHTML = `
                    <div class="export-card">
                        <h3>📊 Statistiche Inventario</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: var(--light-color); border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: var(--primary-color);">${stats.totalProducts}</div>
                                <div style="font-size: 0.8em; color: #666;">Prodotti Totali</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: var(--light-color); border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: var(--success-color);">€${stats.totalValue.toFixed(0)}</div>
                                <div style="font-size: 0.8em; color: #666;">Valore Totale</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: var(--light-color); border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: var(--danger-color);">${stats.outOfStock}</div>
                                <div style="font-size: 0.8em; color: #666;">Esauriti</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: var(--light-color); border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: var(--warning-color);">${stats.lowStock}</div>
                                <div style="font-size: 0.8em; color: #666;">Stock Bassi</div>
                            </div>
                        </div>
                    </div>

                    <div class="export-card">
                        <h3>📤 Esporta Dati</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn-full btn-success" onclick="stockApp.exportCSV()">
                                📊 Esporta CSV
                            </button>
                            <button class="btn-full btn-primary" onclick="stockApp.exportJSON()">
                                💾 Backup JSON
                            </button>
                            <button class="btn-full btn-secondary" onclick="stockApp.shareData()">
                                📱 Condividi Dati
                            </button>
                            <button class="btn-full btn-primary" onclick="stockApp.printReport()">
                                🖨️ Stampa Report
                            </button>
                        </div>
                    </div>

                    <div class="export-card">
                        <h3>📥 Importa Dati</h3>
                        <input type="file" id="importFile" accept=".json,.csv" style="margin-bottom: 10px;">
                        <button class="btn-full btn-secondary" onclick="stockApp.importData()">
                            📥 Importa File
                        </button>
                    </div>

                    <div class="export-card">
                        <h3>⚙️ Impostazioni</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn-full btn-secondary" onclick="stockApp.clearAllData()">
                                🗑️ Cancella Tutti i Dati
                            </button>
                            <button class="btn-full btn-primary" onclick="stockApp.resetToDefaults()">
                                🔄 Reset ai Valori di Default
                            </button>
                        </div>
                    </div>
                `;
            }

            // ==================== UTILITY FUNCTIONS ====================
            getFilteredData() {
                let filtered = this.stockData.filter(product => {
                    const matchesSearch = product.prodotto.toLowerCase().includes(this.searchTerm) ||
                                        product.categoria.toLowerCase().includes(this.searchTerm);
                    
                    const matchesFilter = this.currentFilter === '' || 
                                        this.getProductStatus(product) === this.currentFilter;
                    
                    return matchesSearch && matchesFilter;
                });

                return filtered.sort((a, b) => {
                    // Sort by status (urgent first), then by name
                    const statusA = this.getProductStatus(a);
                    const statusB = this.getProductStatus(b);
                    
                    if (statusA !== statusB) {
                        const order = { 'out': 0, 'low': 1, 'ok': 2 };
                        return order[statusA] - order[statusB];
                    }
                    
                    return a.prodotto.localeCompare(b.prodotto);
                });
            }

            getProductStatus(product) {
                if (product.stockAttuale <= 0) return 'out';
                if (product.stockAttuale <= product.stockMinimo) return 'low';
                return 'ok';
            }

            getStatusText(status) {
                switch (status) {
                    case 'out': return '❌ Esaurito';
                    case 'low': return '⚠️ Basso';
                    case 'ok': return '✅ OK';
                    default: return '';
                }
            }

            getAlertSuggestion(product, status) {
                if (status === 'out') {
                    return `URGENTE: Riordinare ${product.prodotto} immediatamente!`;
                } else if (status === 'low') {
                    const needed = Math.max(product.stockMinimo * 2 - product.stockAttuale, 1);
                    return `Riordinare ${needed} unità di ${product.prodotto} entro 2-3 giorni`;
                }
                return '';
            }

            getCategoryIcon(category) {
                const icons = {
                    'Formaggi': '🧀',
                    'Verdure': '🥬',
                    'Carne': '🥩',
                    'Frutta': '🍎',
                    'Pasta': '🍝',
                    'Salumi': '🥓',
                    'Dolci': '🍰',
                    'Condimenti': '🧂',
                    'Latticini': '🥛',
                    'Erbe': '🌿',
                    'Pesce': '🐟',
                    'Bevande': '🥤'
                };
                return icons[category] || '📦';
            }

            groupByCategory() {
                const grouped = {};
                this.stockData.forEach(product => {
                    if (!grouped[product.categoria]) {
                        grouped[product.categoria] = [];
                    }
                    grouped[product.categoria].push(product);
                });
                return grouped;
            }

            getInventoryStats() {
                return {
                    totalProducts: this.stockData.length,
                    totalValue: this.stockData.reduce((sum, p) => sum + (p.stockAttuale * p.prezzo), 0),
                    outOfStock: this.stockData.filter(p => this.getProductStatus(p) === 'out').length,
                    lowStock: this.stockData.filter(p => this.getProductStatus(p) === 'low').length
                };
            }

            updateStats() {
                const stats = this.getInventoryStats();
                document.getElementById('headerTotal').textContent = stats.totalProducts;
                document.getElementById('headerAlerts').textContent = stats.outOfStock + stats.lowStock;
            }

            updateFilterChips() {
                const stats = this.getInventoryStats();
                const chips = document.querySelectorAll('.chip');
                
                chips.forEach(chip => {
                    const filter = chip.dataset.filter;
                    const text = chip.textContent.split(' ')[0];
                    
                    switch (filter) {
                        case 'out':
                            chip.textContent = `${text} (${stats.outOfStock})`;
                            break;
                        case 'low':
                            chip.textContent = `${text} (${stats.lowStock})`;
                            break;
                    }
                });
            }

            switchView(view) {
                this.currentView = view;
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-view="${view}"]`).classList.add('active');
                
                // Update FAB
                const fab = document.getElementById('addProductFAB');
                if (view === 'orders') {
                    fab.innerHTML = '🛒';
                    fab.title = 'Nuovo ordine';
                } else if (view === 'chat') {
                    fab.innerHTML = '💬';
                    fab.title = 'Scrivi messaggio';
                } else {
                    fab.innerHTML = '+';
                    fab.title = 'Aggiungi prodotto';
                }
                
                this.render();
            }

            // ==================== PRODUCT MANAGEMENT ====================
            handleProductClick(e) {
                const productId = parseInt(e.target.dataset.productId);
                if (!productId) return;

                const product = this.stockData.find(p => p.id === productId);
                if (!product) return;

                if (e.target.classList.contains('increase-btn')) {
                    this.updateStock(productId, 1);
                } else if (e.target.classList.contains('decrease-btn')) {
                    this.updateStock(productId, -1);
                }
            }

            async updateStock(productId, change) {
                const product = this.stockData.find(p => p.id === productId);
                if (!product) return;

                const newStock = Math.max(0, product.stockAttuale + change);
                product.stockAttuale = newStock;

                // Update UI immediately
                this.render();

                // Sync to Firebase
                await this.syncToFirebase('stock', product, product.id);

                // Show toast for important changes
                if (newStock === 0) {
                    this.showToast(`⚠️ ${product.prodotto} è esaurito!`, 'warning');
                } else if (newStock === product.stockMinimo) {
                    this.showToast(`⚠️ ${product.prodotto} ha raggiunto il minimo`, 'warning');
                }
            }

            openAddProductModal() {
                document.getElementById('addProductModal').classList.add('show');
                document.getElementById('newProduct').focus();
            }

            async handleAddProduct(e) {
                e.preventDefault();
                
                const categoria = document.getElementById('newCategory').value;
                const prodotto = document.getElementById('newProduct').value.trim();
                const stockAttuale = parseInt(document.getElementById('newStock').value) || 0;
                const stockMinimo = parseInt(document.getElementById('newMinStock').value) || 5;
                const prezzo = parseFloat(document.getElementById('newPrice').value) || 0;

                if (!categoria || !prodotto) {
                    this.showToast('Compila tutti i campi obbligatori', 'error');
                    return;
                }

                const newProduct = {
                    id: this.nextId++,
                    categoria,
                    prodotto,
                    stockAttuale,
                    stockMinimo,
                    prezzo
                };

                this.stockData.push(newProduct);
                await this.syncToFirebase('stock', newProduct, newProduct.id);
                
                this.closeAllModals();
                this.render();
                this.showToast(`✅ ${prodotto} aggiunto!`, 'success');
                
                // Reset form
                document.getElementById('addProductForm').reset();
            }

            // ==================== ORDER MANAGEMENT ====================
            openNewOrderModal() {
                // Create modal HTML
                const modalHTML = `
                    <div id="newOrderModal" class="modal show">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>🛒 Nuovo Ordine</h3>
                                <button class="close-btn" type="button">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="newOrderForm">
                                    <div class="form-group">
                                        <label class="form-label">Fornitore *</label>
                                        <select id="orderSupplier" class="form-input" required>
                                            <option value="">Seleziona fornitore</option>
                                            ${this.suppliersData.map(s => 
                                                `<option value="${s.id}">${s.nome}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Prodotti</label>
                                        <div id="orderItemsContainer">
                                            <div class="order-item-input">
                                                <input type="text" class="form-input" placeholder="Nome prodotto" style="margin-bottom: 8px;">
                                                <div style="display: flex; gap: 8px;">
                                                    <input type="number" class="form-input" placeholder="Qtà" min="1" style="width: 70px;">
                                                    <input type="text" class="form-input" placeholder="Unità" value="pz" style="width: 70px;">
                                                    <input type="number" class="form-input" placeholder="Prezzo €" min="0" step="0.01" style="flex: 1;">
                                                    <button type="button" class="btn-circle btn-danger" onclick="this.parentElement.parentElement.remove()">×</button>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" class="btn-full btn-secondary" onclick="stockApp.addOrderItem()">
                                            ➕ Aggiungi Prodotto
                                        </button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Note</label>
                                        <textarea id="orderNote" class="form-input" rows="3" placeholder="Note per l'ordine..."></textarea>
                                    </div>
                                    <button type="submit" class="btn-full btn-success">💾 Salva Ordine</button>
                                    <button type="button" class="btn-full btn-cancel modal-close">❌ Annulla</button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if present
                const existingModal = document.getElementById('newOrderModal');
                if (existingModal) existingModal.remove();

                // Add modal to DOM
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Setup form handler
                document.getElementById('newOrderForm').addEventListener('submit', (e) => {
                    this.handleNewOrder(e);
                });
            }

            addOrderItem() {
                const container = document.getElementById('orderItemsContainer');
                const newItem = document.createElement('div');
                newItem.className = 'order-item-input';
                newItem.innerHTML = `
                    <input type="text" class="form-input" placeholder="Nome prodotto" style="margin-bottom: 8px;">
                    <div style="display: flex; gap: 8px;">
                        <input type="number" class="form-input" placeholder="Qtà" min="1" style="width: 70px;">
                        <input type="text" class="form-input" placeholder="Unità" value="pz" style="width: 70px;">
                        <input type="number" class="form-input" placeholder="Prezzo €" min="0" step="0.01" style="flex: 1;">
                        <button type="button" class="btn-circle btn-danger" onclick="this.parentElement.parentElement.remove()">×</button>
                    </div>
                `;
                container.appendChild(newItem);
            }

            async handleNewOrder(e) {
                e.preventDefault();
                
                const fornitoreId = parseInt(document.getElementById('orderSupplier').value);
                const note = document.getElementById('orderNote').value.trim();
                
                if (!fornitoreId) {
                    this.showToast('Seleziona un fornitore', 'error');
                    return;
                }

                // Collect order items
                const items = [];
                const itemInputs = document.querySelectorAll('.order-item-input');
                
                itemInputs.forEach(input => {
                    const inputs = input.querySelectorAll('input');
                    const prodotto = inputs[0].value.trim();
                    const quantita = parseInt(inputs[1].value) || 0;
                    const unita = inputs[2].value.trim() || 'pz';
                    const prezzo = parseFloat(inputs[3].value) || 0;
                    
                    if (prodotto && quantita > 0) {
                        items.push({ prodotto, quantita, unita, prezzo });
                    }
                });

                if (items.length === 0) {
                    this.showToast('Aggiungi almeno un prodotto', 'error');
                    return;
                }

                const newOrder = {
                    id: this.nextOrderId++,
                    fornitoreId,
                    items,
                    note,
                    stato: 'pending',
                    dataCreazione: new Date().toISOString()
                };

                this.ordersData.push(newOrder);
                await this.syncToFirebase('orders', newOrder, newOrder.id);
                
                this.closeAllModals();
                this.render();
                this.showToast(`✅ Ordine #${newOrder.id} creato!`, 'success');
            }

            createQuickOrder() {
                const lowStockProducts = this.stockData.filter(p => this.getProductStatus(p) !== 'ok');
                
                if (lowStockProducts.length === 0) {
                    this.showToast('Nessun prodotto necessita di riordino', 'success');
                    return;
                }

                // Open new order modal with pre-filled items
                this.openNewOrderModal();
                
                setTimeout(() => {
                    const container = document.getElementById('orderItemsContainer');
                    if (container) {
                        container.innerHTML = lowStockProducts.slice(0, 5).map(product => {
                            const suggestedQty = Math.max(product.stockMinimo * 2 - product.stockAttuale, 1);
                            return `
                                <div class="order-item-input">
                                    <input type="text" class="form-input" value="${this.escapeHtml(product.prodotto)}" style="margin-bottom: 8px;">
                                    <div style="display: flex; gap: 8px;">
                                        <input type="number" class="form-input" value="${suggestedQty}" min="1" style="width: 70px;">
                                        <input type="text" class="form-input" value="pz" style="width: 70px;">
                                        <input type="number" class="form-input" value="${product.prezzo}" min="0" step="0.01" style="flex: 1;">
                                        <button type="button" class="btn-circle btn-danger" onclick="this.parentElement.parentElement.remove()">×</button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }, 100);
            }

            async completeOrder(orderId) {
                const order = this.ordersData.find(o => o.id === orderId);
                if (!order) return;

                order.stato = 'completed';
                order.dataCompletamento = new Date().toISOString();

                // Ask if user wants to update stock
                if (confirm('Vuoi aggiornare automaticamente lo stock con i prodotti ordinati?')) {
                    order.items.forEach(item => {
                        const product = this.stockData.find(p => 
                            p.prodotto.toLowerCase() === item.prodotto.toLowerCase()
                        );
                        if (product) {
                            product.stockAttuale += item.quantita;
                        }
                    });

                    // Sync updated stock
                    for (const product of this.stockData) {
                        await this.syncToFirebase('stock', product, product.id);
                    }
                }

                await this.syncToFirebase('orders', order, order.id);
                this.render();
                this.showToast(`✅ Ordine #${orderId} completato!`, 'success');
            }

            async deleteOrder(orderId) {
                if (!confirm('Sei sicuro di voler eliminare questo ordine?')) return;

                this.ordersData = this.ordersData.filter(o => o.id !== orderId);
                await this.deleteFromFirebase('orders', orderId);
                this.render();
                this.showToast('🗑️ Ordine eliminato', 'success');
            }

            viewOrderDetails(orderId) {
                const order = this.ordersData.find(o => o.id === orderId);
                if (!order) return;

                const supplier = this.suppliersData.find(s => s.id === order.fornitoreId);
                const supplierName = supplier ? supplier.nome : 'Fornitore sconosciuto';
                const totalValue = order.items.reduce((sum, item) => sum + (item.quantita * item.prezzo), 0);

                const modalHTML = `
                    <div id="orderDetailsModal" class="modal show">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>📋 Ordine #${order.id}</h3>
                                <button class="close-btn" type="button">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="detail-section">
                                    <h4>Informazioni Ordine</h4>
                                    <div class="detail-item">
                                        <span>Fornitore:</span>
                                        <strong>${this.escapeHtml(supplierName)}</strong>
                                    </div>
                                    <div class="detail-item">
                                        <span>Data Creazione:</span>
                                        <span>${new Date(order.dataCreazione).toLocaleString('it-IT')}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span>Stato:</span>
                                        <span class="status-badge status-${order.stato === 'pending' ? 'low' : 'ok'}">
                                            ${order.stato === 'pending' ? '⏳ In Attesa' : '✅ Completato'}
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <span>Valore Totale:</span>
                                        <strong style="color: var(--success-color);">€${totalValue.toFixed(2)}</strong>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <h4>Prodotti (${order.items.length})</h4>
                                    <div class="order-items-list">
                                        ${order.items.map(item => `
                                            <div class="order-item-detail">
                                                <div class="item-info">
                                                    <strong>${this.escapeHtml(item.prodotto)}</strong>
                                                    <span class="item-price">€${(item.quantita * item.prezzo).toFixed(2)}</span>
                                                </div>
                                                <div class="item-qty">${item.quantita} ${item.unita} × €${item.prezzo.toFixed(2)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                ${order.note ? `
                                    <div class="detail-section">
                                        <h4>Note</h4>
                                        <div class="order-note-detail">${this.escapeHtml(order.note)}</div>
                                    </div>
                                ` : ''}

                                <div class="order-actions-modal">
                                    ${order.stato === 'pending' ? `
                                        <button class="btn-full btn-success" onclick="stockApp.completeOrder(${order.id}); stockApp.closeAllModals();">
                                            ✅ Segna come Completato
                                        </button>
                                    ` : ''}
                                    <button class="btn-full btn-cancel modal-close">Chiudi</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // ==================== SUPPLIER MANAGEMENT ====================
            openAddSupplierModal() {
                const modalHTML = `
                    <div id="addSupplierModal" class="modal show">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>🏪 Nuovo Fornitore</h3>
                                <button class="close-btn" type="button">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="addSupplierForm">
                                    <div class="form-group">
                                        <label class="form-label">Nome Fornitore *</label>
                                        <input type="text" id="supplierName" class="form-input" required placeholder="Es. Metro Cash & Carry">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Tipo *</label>
                                        <select id="supplierType" class="form-input" required>
                                            <option value="">Seleziona tipo</option>
                                            <option value="Supermercato">🛒 Supermercato</option>
                                            <option value="Cash & Carry">🏪 Cash & Carry</option>
                                            <option value="Fornitore">🚚 Fornitore Specializzato</option>
                                            <option value="Mercato">🥬 Mercato</option>
                                            <option value="Altro">📦 Altro</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Telefono</label>
                                        <input type="tel" id="supplierPhone" class="form-input" placeholder="Es. 06-12345678">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Note</label>
                                        <textarea id="supplierNote" class="form-input" rows="3" placeholder="Orari, condizioni, sconti, etc..."></textarea>
                                    </div>
                                    <button type="submit" class="btn-full btn-success">💾 Salva Fornitore</button>
                                    <button type="button" class="btn-full btn-cancel modal-close">❌ Annulla</button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                document.getElementById('addSupplierForm').addEventListener('submit', (e) => {
                    this.handleAddSupplier(e);
                });
            }

            async handleAddSupplier(e) {
                e.preventDefault();
                
                const nome = document.getElementById('supplierName').value.trim();
                const tipo = document.getElementById('supplierType').value;
                const telefono = document.getElementById('supplierPhone').value.trim();
                const note = document.getElementById('supplierNote').value.trim();

                if (!nome || !tipo) {
                    this.showToast('Compila i campi obbligatori', 'error');
                    return;
                }

                const newSupplier = {
                    id: this.nextSupplierId++,
                    nome,
                    tipo,
                    telefono,
                    note
                };

                this.suppliersData.push(newSupplier);
                await this.syncToFirebase('suppliers', newSupplier, newSupplier.id);
                
                this.closeAllModals();
                this.render();
                this.showToast(`✅ ${nome} aggiunto!`, 'success');
            }

            createOrderForSupplier(supplierId) {
                this.openNewOrderModal();
                setTimeout(() => {
                    document.getElementById('orderSupplier').value = supplierId;
                }, 100);
            }

            async deleteSupplier(supplierId) {
                if (!confirm('Sei sicuro di voler eliminare questo fornitore?')) return;

                // Check if supplier has orders
                const hasOrders = this.ordersData.some(o => o.fornitoreId === supplierId);
                if (hasOrders && !confirm('Questo fornitore ha degli ordini associati. Continuare?')) {
                    return;
                }

                this.suppliersData = this.suppliersData.filter(s => s.id !== supplierId);
                await this.deleteFromFirebase('suppliers', supplierId);
                this.render();
                this.showToast('🗑️ Fornitore eliminato', 'success');
            }

            // ==================== EXPORT FUNCTIONS ====================
            exportCSV() {
                const csvContent = this.generateCSV();
                this.downloadFile(csvContent, 'stock-ristorante.csv', 'text/csv');
                this.showToast('📊 CSV esportato!', 'success');
            }

            generateCSV() {
                const headers = ['Categoria', 'Prodotto', 'Stock Attuale', 'Stock Minimo', 'Prezzo', 'Valore Totale', 'Stato'];
                const rows = this.stockData.map(product => [
                    product.categoria,
                    product.prodotto,
                    product.stockAttuale,
                    product.stockMinimo,
                    product.prezzo.toFixed(2),
                    (product.stockAttuale * product.prezzo).toFixed(2),
                    this.getStatusText(this.getProductStatus(product))
                ]);

                return [headers, ...rows]
                    .map(row => row.map(field => `"${field}"`).join(','))
                    .join('\n');
            }

            exportJSON() {
                const data = {
                    stockData: this.stockData,
                    ordersData: this.ordersData,
                    suppliersData: this.suppliersData,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                const jsonContent = JSON.stringify(data, null, 2);
                this.downloadFile(jsonContent, 'stock-backup.json', 'application/json');
                this.showToast('💾 Backup creato!', 'success');
            }

            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            async shareData() {
                const data = {
                    stockData: this.stockData,
                    suppliersData: this.suppliersData,
                    exportDate: new Date().toISOString()
                };

                const shareText = `Stock Ristorante - ${new Date().toLocaleDateString('it-IT')}\n\n${JSON.stringify(data, null, 2)}`;

                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Stock Ristorante',
                            text: shareText
                        });
                        this.showToast('📱 Dati condivisi!', 'success');
                    } catch (error) {
                        this.copyToClipboard(shareText);
                    }
                } else {
                    this.copyToClipboard(shareText);
                }
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast('📋 Dati copiati negli appunti!', 'success');
                }).catch(() => {
                    this.showToast('❌ Errore nella copia', 'error');
                });
            }

            importData() {
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    this.showToast('Seleziona un file da importare', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.stockData) {
                            this.stockData = data.stockData;
                            this.updateNextId();
                        }
                        if (data.ordersData) {
                            this.ordersData = data.ordersData;
                            this.updateNextOrderId();
                        }
                        if (data.suppliersData) {
                            this.suppliersData = data.suppliersData;
                            this.updateNextSupplierId();
                        }

                        this.saveToLocalStorage();
                        this.render();
                        this.showToast('📥 Dati importati con successo!', 'success');
                        
                        // Sync to Firebase
                        this.syncOfflineChanges();
                    } catch (error) {
                        this.showToast('❌ File non valido', 'error');
                    }
                };
                reader.readAsText(file);
            }

            printReport() {
                const printContent = this.generatePrintReport();
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }

            generatePrintReport() {
                const stats = this.getInventoryStats();
                const currentDate = new Date().toLocaleDateString('it-IT');

                return `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Stock Ristorante - Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                            .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                            .stat-box { border: 1px solid #ddd; padding: 15px; text-align: center; }
                            .product-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            .product-table th, .product-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            .product-table th { background-color: #f5f5f5; }
                            .status-ok { color: green; font-weight: bold; }
                            .status-low { color: orange; font-weight: bold; }
                            .status-out { color: red; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>📦 Stock Ristorante</h1>
                            <h2>Report Inventario</h2>
                            <p>Generato il ${currentDate} da ${this.currentUser?.name || 'Utente'}</p>
                        </div>
                        
                        <div class="stats">
                            <div class="stat-box">
                                <h3>${stats.totalProducts}</h3>
                                <p>Prodotti Totali</p>
                            </div>
                            <div class="stat-box">
                                <h3>€${stats.totalValue.toFixed(2)}</h3>
                                <p>Valore Inventario</p>
                            </div>
                            <div class="stat-box">
                                <h3>${stats.outOfStock}</h3>
                                <p>Prodotti Esauriti</p>
                            </div>
                            <div class="stat-box">
                                <h3>${stats.lowStock}</h3>
                                <p>Stock Bassi</p>
                            </div>
                        </div>

                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>Categoria</th>
                                    <th>Prodotto</th>
                                    <th>Stock</th>
                                    <th>Min</th>
                                    <th>Prezzo</th>
                                    <th>Valore</th>
                                    <th>Stato</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.stockData.map(product => {
                                    const status = this.getProductStatus(product);
                                    const value = product.stockAttuale * product.prezzo;
                                    return `
                                        <tr>
                                            <td>${product.categoria}</td>
                                            <td>${product.prodotto}</td>
                                            <td>${product.stockAttuale}</td>
                                            <td>${product.stockMinimo}</td>
                                            <td>€${product.prezzo.toFixed(2)}</td>
                                            <td>€${value.toFixed(2)}</td>
                                            <td class="status-${status}">${this.getStatusText(status)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>

                        <div style="margin-top: 30px; text-align: center; color: #666; font-size: 0.9em;">
                            Report generato da Stock Ristorante App - Sincronizzazione Firebase attiva
                        </div>
                    </body>
                    </html>
                `;
            }

            // ==================== UTILITY FUNCTIONS ====================
            clearAllData() {
                if (!confirm('⚠️ ATTENZIONE: Questa azione cancellerà TUTTI i dati!\n\nSei sicuro di voler continuare?')) {
                    return;
                }

                if (!confirm('🚨 ULTIMA CONFERMA: Tutti i prodotti, ordini e fornitori verranno eliminati!\n\nContinuare?')) {
                    return;
                }

                this.stockData = [];
                this.ordersData = [];
                this.suppliersData = [];
                this.nextId = 1;
                this.nextOrderId = 1;
                this.nextSupplierId = 1;

                this.saveToLocalStorage();
                this.render();
                this.showToast('🗑️ Tutti i dati sono stati cancellati', 'success');
            }

            resetToDefaults() {
                if (!confirm('Ripristinare i dati di esempio?')) return;

                this.loadDefaultData();
                this.render();
                this.showToast('🔄 Dati ripristinati', 'success');
            }

            closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        if (modal.id !== 'addProductModal' && modal.id !== 'userSetupModal') {
                            modal.remove();
                        }
                    }, 300);
                });
            }

            showLoading() {
                document.getElementById('loadingOverlay').style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            startAutoSave() {
                setInterval(() => {
                    this.saveToLocalStorage();
                }, 30000); // Auto-save every 30 seconds
            }
        }

        // Initialize the app
        const stockApp = new StockRistoranteApp();

        // Make it globally accessible
        window.stockApp = stockApp;

        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>

